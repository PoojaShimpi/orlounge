!function(t){function e(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function n(){var t=require("util");return"Markdown.mk_block( "+t.inspect(this.toString())+", "+t.inspect(this.trailing)+", "+t.inspect(this.lineNumber)+" )"}function i(t){for(var e=0,n=-1;-1!==(n=t.indexOf("\n",n+1));)e++;return e}function r(t,e){function n(t){this.len_after=t,this.name="close_"+e}var i=t+"_state",r="strong"==t?"em_state":"strong_state";return function(a,s){if(this[i][0]==e)return this[i].shift(),[a.length,new n(a.length-e.length)];var l=this[r].slice(),o=this[i].slice();this[i].unshift(e);var c=this.processInline(a.substr(e.length)),h=c[c.length-1];this[i].shift();return h instanceof n?(c.pop(),[a.length-h.len_after,[t].concat(c)]):(this[r]=l,this[i]=o,[e.length,e])}}function s(t){for(var e=t.split(""),n=[""],i=!1;e.length;){var r=e.shift();switch(r){case" ":i?n[n.length-1]+=r:n.push("");break;case"'":case'"':i=!i;break;case"\\":r=e.shift();default:n[n.length-1]+=r}}return n}function l(t){return v(t)&&t.length>1&&"object"==typeof t[1]&&!v(t[1])?t[1]:void 0}function o(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function c(t){if("string"==typeof t)return o(t);var e=t.shift(),n={},i=[];for(!t.length||"object"!=typeof t[0]||t[0]instanceof Array||(n=t.shift());t.length;)i.push(arguments.callee(t.shift()));var r="";for(var a in n)r+=" "+a+'="'+o(n[a])+'"';return"img"==e||"br"==e||"hr"==e?"<"+e+r+"/>":"<"+e+r+">"+i.join("")+"</"+e+">"}function h(t,e,n){var i;n=n||{};var r=t.slice(0);"function"==typeof n.preprocessTreeNode&&(r=n.preprocessTreeNode(r,e));var a=l(r);if(a){r[1]={};for(i in a)r[1][i]=a[i];a=r[1]}if("string"==typeof r)return r;switch(r[0]){case"header":r[0]="h"+r[1].level,delete r[1].level;break;case"bulletlist":r[0]="ul";break;case"numberlist":r[0]="ol";break;case"listitem":r[0]="li";break;case"para":r[0]="p";break;case"markdown":r[0]="html",a&&delete a.references;break;case"code_block":r[0]="pre",i=a?2:1;var s=["code"];s.push.apply(s,r.splice(i)),r[i]=s;break;case"inlinecode":r[0]="code";break;case"img":r[1].src=r[1].href,delete r[1].href;break;case"linebreak":r[0]="br";break;case"link":r[0]="a";break;case"link_ref":if(r[0]="a",!(o=e[a.ref]))return a.original;delete a.ref,a.href=o.href,o.title&&(a.title=o.title),delete a.original;break;case"img_ref":r[0]="img";var o=e[a.ref];if(!o)return a.original;delete a.ref,a.src=o.href,o.title&&(a.title=o.title),delete a.original}if(i=1,a){for(var c in r[1])i=2;1===i&&r.splice(i,1)}for(;i<r.length;++i)r[i]=arguments.callee(r[i],e,n);return r}function u(t){for(var e=l(t)?2:1;e<t.length;)"string"==typeof t[e]?e+1<t.length&&"string"==typeof t[e+1]?t[e]+=t.splice(e+1,1)[0]:++e:(arguments.callee(t[e]),++e)}var f=t.Markdown=function t(e){switch(typeof e){case"undefined":this.dialect=t.dialects.Gruber;break;case"object":this.dialect=e;break;default:if(!(e in t.dialects))throw new Error("Unknown Markdown dialect '"+String(e)+"'");this.dialect=t.dialects[e]}this.em_state=[],this.strong_state=[],this.debug_indent=""};t.parse=function(t,e){return new f(e).toTree(t)},t.toHTML=function(e,n,i){var r=t.toHTMLTree(e,n,i);return t.renderJsonML(r)},t.toHTMLTree=function(t,e,n){"string"==typeof t&&(t=this.parse(t,e));var i=l(t),r={};i&&i.references&&(r=i.references);var a=h(t,r,n);return u(a),a};var d=f.mk_block=function(t,i,r){1==arguments.length&&(i="\n\n");var a=new String(t);return a.trailing=i,a.inspect=n,a.toSource=e,void 0!=r&&(a.lineNumber=r),a};f.prototype.split_blocks=function(t,e){var n,r=/([\s\S]+?)($|\n(?:\s*\n|$)+)/g,a=[],s=1;for(null!=(n=/^(\s*\n)/.exec(t))&&(s+=i(n[0]),r.lastIndex=n[0].length);null!==(n=r.exec(t));)a.push(d(n[1],n[2],s)),s+=i(n[0]);return a},f.prototype.processBlock=function(t,e){var n=this.dialect.block,i=n.__order__;if("__call__"in n)return n.__call__.call(this,t,e);for(var r=0;r<i.length;r++){var a=n[i[r]].call(this,t,e);if(a)return(!v(a)||a.length>0&&!v(a[0]))&&this.debug(i[r],"didn't return a proper array"),a}return[]},f.prototype.processInline=function(t){return this.dialect.inline.__call__.call(this,String(t))},f.prototype.toTree=function(t,e){var n=t instanceof Array?t:this.split_blocks(t),i=this.tree;try{for(this.tree=e||this.tree||["markdown"];n.length;){var r=this.processBlock(n.shift(),n);r.length&&this.tree.push.apply(this.tree,r)}return this.tree}finally{e&&(this.tree=i)}},f.prototype.debug=function(){var t=Array.prototype.slice.call(arguments);t.unshift(this.debug_indent),"undefined"!=typeof print&&print.apply(print,t),"undefined"!=typeof console&&void 0!==console.log&&console.log.apply(null,t)},f.prototype.loop_re_over_block=function(t,e,n){for(var i,r=e.valueOf();r.length&&null!=(i=t.exec(r));)r=r.substr(i[0].length),n.call(this,i);return r},f.dialects={},f.dialects.Gruber={block:{atxHeader:function(t,e){var n=t.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(n){var i=["header",{level:n[1].length}];return Array.prototype.push.apply(i,this.processInline(n[2])),n[0].length<t.length&&e.unshift(d(t.substr(n[0].length),t.trailing,t.lineNumber+2)),[i]}},setextHeader:function(t,e){var n=t.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(n){var i=["header",{level:"="===n[2]?1:2},n[1]];return n[0].length<t.length&&e.unshift(d(t.substr(n[0].length),t.trailing,t.lineNumber+2)),[i]}},code:function(t,e){var n=[],i=/^(?: {0,3}\t| {4})(.*)\n?/;if(t.match(i)){t:for(;;){var r=this.loop_re_over_block(i,t.valueOf(),function(t){n.push(t[1])});if(r.length){e.unshift(d(r,t.trailing));break t}if(!e.length)break t;if(!e[0].match(i))break t;n.push(t.trailing.replace(/[^\n]/g,"").substring(2)),t=e.shift()}return[["code_block",n.join("\n")]]}},horizRule:function(t,e){var n=t.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(n){var i=[["hr"]];return n[1]&&i.unshift.apply(i,this.processBlock(n[1],[])),n[3]&&e.unshift(d(n[3])),i}},lists:function(){function t(t){return new RegExp("(?:^("+o+"{0,"+t+"} {0,3})("+a+")\\s+)|(^"+o+"{0,"+(t-1)+"}[ ]{0,4})")}function e(t){return t.replace(/ {0,3}\t/g,"    ")}function n(t,e,n,i){if(e)t.push(["para"].concat(n));else{var r=t[t.length-1]instanceof Array&&"para"==t[t.length-1][0]?t[t.length-1]:t;i&&t.length>1&&n.unshift(i);for(var a=0;a<n.length;a++){var s=n[a];"string"==typeof s&&r.length>1&&"string"==typeof r[r.length-1]?r[r.length-1]+=s:r.push(s)}}}function i(t,e){for(var n=new RegExp("^("+o+"{"+t+"}.*?\\n?)*$"),i=new RegExp("^"+o+"{"+t+"}","gm"),r=[];e.length>0;){if(n.exec(e[0])){var a=e.shift(),s=a.replace(i,"");r.push(d(s,a.trailing,a.lineNumber))}break}return r}function r(t,e,n){var i=t.list,r=i[i.length-1];if(!(r[1]instanceof Array&&"para"==r[1][0]))if(e+1==n.length)r.push(["para"].concat(r.splice(1)));else{var a=r.pop();r.push(["para"].concat(r.splice(1)),a)}}var a="[*+-]|\\d+\\.",s=/[*+-]/,l=new RegExp("^( {0,3})("+a+")[ \t]+"),o="(?: {0,3}\\t| {4})";return function(a,o){function c(t){var e=s.exec(t[2])?["bulletlist"]:["numberlist"];return d.push({list:e,indent:t[1]}),e}var h=a.match(l);if(h){for(var u,f,d=[],p=c(h),v=!1,b=[d[0].list];;){for(var m=a.split(/(?=\n)/),_="",k=0;k<m.length;k++){var y="",w=m[k].replace(/^\n/,function(t){return y=t,""}),x=t(d.length);if(void 0!==(h=w.match(x))[1]){_.length&&(n(u,v,this.processInline(_),y),v=!1,_=""),h[1]=e(h[1]);var $=Math.floor(h[1].length/4)+1;if($>d.length)p=c(h),u.push(p),u=p[1]=["listitem"];else{var S=!1;for(f=0;f<d.length;f++)if(d[f].indent==h[1]){p=d[f].list,d.splice(f+1),S=!0;break}S||(++$<=d.length?(d.splice($),p=d[$-1].list):(p=c(h),u.push(p))),u=["listitem"],p.push(u)}y=""}w.length>h[0].length&&(_+=y+w.substr(h[0].length))}_.length&&(n(u,v,this.processInline(_),y),v=!1,_="");var C=i(d.length,o);C.length>0&&(g(d,r,this),u.push.apply(u,this.toTree(C,[])));var B=o[0]&&o[0].valueOf()||"";if(!B.match(l)&&!B.match(/^ /))break;a=o.shift();var z=this.dialect.block.horizRule(a,o);if(z){b.push.apply(b,z);break}g(d,r,this),v=!0}return b}}}(),blockquote:function(t,e){if(t.match(/^>/m)){var n=[];if(">"!=t[0]){for(var i=t.split(/\n/),r=[];i.length&&">"!=i[0][0];)r.push(i.shift());t=i.join("\n"),n.push.apply(n,this.processBlock(r.join("\n"),[]))}for(;e.length&&">"==e[0][0];){var a=e.shift();(t=new String(t+t.trailing+a)).trailing=a.trailing}var s=t.replace(/^> ?/gm,"");this.tree;return n.push(this.toTree(s,["blockquote"])),n}},referenceDefn:function(t,e){var n=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(t.match(n)){l(this.tree)||this.tree.splice(1,0,{});var i=l(this.tree);void 0===i.references&&(i.references={});var r=this.loop_re_over_block(n,t,function(t){t[2]&&"<"==t[2][0]&&">"==t[2][t[2].length-1]&&(t[2]=t[2].substring(1,t[2].length-1));var e=i.references[t[1].toLowerCase()]={href:t[2]};void 0!==t[4]?e.title=t[4]:void 0!==t[5]&&(e.title=t[5])});return r.length&&e.unshift(d(r,t.trailing)),[]}},para:function(t,e){return[["para"].concat(this.processInline(t))]}}},f.dialects.Gruber.inline={__oneElement__:function(t,e,n){var i;if(e=e||this.dialect.inline.__patterns__,!(i=new RegExp("([\\s\\S]*?)("+(e.source||e)+")").exec(t)))return[t.length,t];if(i[1])return[i[1].length,i[1]];var r;return i[2]in this.dialect.inline&&(r=this.dialect.inline[i[2]].call(this,t.substr(i.index),i,n||[])),r=r||[i[2].length,i[2]]},__call__:function(t,e){for(var n,i=[];t.length>0;)n=this.dialect.inline.__oneElement__.call(this,t,e,i),t=t.substr(n.shift()),g(n,function(t){"string"==typeof t&&"string"==typeof i[i.length-1]?i[i.length-1]+=t:i.push(t)});return i},"]":function(){},"}":function(){},"\\":function(t){return t.match(/^\\[\\`\*_{}\[\]()#\+.!\-]/)?[2,t[1]]:[1,"\\"]},"![":function(t){var e=t.match(/^!\[(.*?)\][ \t]*\([ \t]*(\S*)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(e){e[2]&&"<"==e[2][0]&&">"==e[2][e[2].length-1]&&(e[2]=e[2].substring(1,e[2].length-1)),e[2]=this.dialect.inline.__call__.call(this,e[2],/\\/)[0];var n={alt:e[1],href:e[2]||""};return void 0!==e[4]&&(n.title=e[4]),[e[0].length,["img",n]]}return e=t.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/),e?[e[0].length,["img_ref",{alt:e[1],ref:e[2].toLowerCase(),original:e[0]}]]:[2,"!["]},"[":function(t){var e=String(t),n=f.DialectHelpers.inline_until_char.call(this,t.substr(1),"]");if(!n)return[1,"["];var i,r,a=1+n[0],s=n[1],l=(t=t.substr(a)).match(/^\s*\([ \t]*(\S+)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(l){var o=l[1];if(a+=l[0].length,o&&"<"==o[0]&&">"==o[o.length-1]&&(o=o.substring(1,o.length-1)),!l[3])for(var c=1,h=0;h<o.length;h++)switch(o[h]){case"(":c++;break;case")":0==--c&&(a-=o.length-h,o=o.substring(0,h))}return o=this.dialect.inline.__call__.call(this,o,/\\/)[0],r={href:o||""},void 0!==l[3]&&(r.title=l[3]),i=["link",r].concat(s),[a,i]}return l=t.match(/^\s*\[(.*?)\]/),l?(a+=l[0].length,r={ref:(l[1]||String(s)).toLowerCase(),original:e.substr(0,a)},i=["link_ref",r].concat(s),[a,i]):1==s.length&&"string"==typeof s[0]?(r={ref:s[0].toLowerCase(),original:e.substr(0,a)},i=["link_ref",r,s[0]],[a,i]):[1,"["]},"<":function(t){var e;return null!=(e=t.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))?e[3]?[e[0].length,["link",{href:"mailto:"+e[3]},e[3]]]:"mailto"==e[2]?[e[0].length,["link",{href:e[1]},e[1].substr("mailto:".length)]]:[e[0].length,["link",{href:e[1]},e[1]]]:[1,"<"]},"`":function(t){var e=t.match(/(`+)(([\s\S]*?)\1)/);return e&&e[2]?[e[1].length+e[2].length,["inlinecode",e[3]]]:[1,"`"]},"  \n":function(t){return[3,["linebreak"]]}},f.dialects.Gruber.inline["**"]=r("strong","**"),f.dialects.Gruber.inline.__=r("strong","__"),f.dialects.Gruber.inline["*"]=r("em","*"),f.dialects.Gruber.inline._=r("em","_"),f.buildBlockOrder=function(t){var e=[];for(var n in t)"__order__"!=n&&"__call__"!=n&&e.push(n);t.__order__=e},f.buildInlinePatterns=function(t){var e=[];for(var n in t)if(!n.match(/^__.*__$/)){var i=n.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");e.push(1==n.length?i:"(?:"+i+")")}e=e.join("|"),t.__patterns__=e;var r=t.__call__;t.__call__=function(t,n){return void 0!=n?r.call(this,t,n):r.call(this,t,e)}},f.DialectHelpers={},f.DialectHelpers.inline_until_char=function(t,e){for(var n=0,i=[];;){if(t[n]==e)return n++,[n,i];if(n>=t.length)return null;var r=this.dialect.inline.__oneElement__.call(this,t.substr(n));n+=r[0],i.push.apply(i,r.slice(1))}},f.subclassDialect=function(t){function e(){}function n(){}return e.prototype=t.block,n.prototype=t.inline,{block:new e,inline:new n}},f.buildBlockOrder(f.dialects.Gruber.block),f.buildInlinePatterns(f.dialects.Gruber.inline),f.dialects.Maruku=f.subclassDialect(f.dialects.Gruber),f.dialects.Maruku.processMetaHash=function(t){for(var e=s(t),n={},i=0;i<e.length;++i)if(/^#/.test(e[i]))n.id=e[i].substring(1);else if(/^\./.test(e[i]))n.class?n.class=n.class+e[i].replace(/./," "):n.class=e[i].substring(1);else if(/\=/.test(e[i])){var r=e[i].split(/\=/);n[r[0]]=r[1]}return n},f.dialects.Maruku.block.document_meta=function(t,e){if(!(t.lineNumber>1)&&t.match(/^(?:\w+:.*\n)*\w+:.*$/)){l(this.tree)||this.tree.splice(1,0,{});var n=t.split(/\n/);for(p in n){var i=n[p].match(/(\w+):\s*(.*)$/),r=i[1].toLowerCase(),a=i[2];this.tree[1][r]=a}return[]}},f.dialects.Maruku.block.block_meta=function(t,e){var n=t.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(n){var i,r=this.dialect.processMetaHash(n[2]);if(""===n[1]){var s=this.tree[this.tree.length-1];if(i=l(s),"string"==typeof s)return;i||(i={},s.splice(1,0,i));for(a in r)i[a]=r[a];return[]}var o=t.replace(/\n.*$/,""),c=this.processBlock(o,[]);(i=l(c[0]))||(i={},c[0].splice(1,0,i));for(a in r)i[a]=r[a];return c}},f.dialects.Maruku.block.definition_list=function(t,e){var n,i=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,r=["dl"];if(l=t.match(i)){for(var a=[t];e.length&&i.exec(e[0]);)a.push(e.shift());for(var s=0;s<a.length;++s){var l=a[s].match(i),o=l[1].replace(/\n$/,"").split(/\n/),c=l[2].split(/\n:\s+/);for(n=0;n<o.length;++n)r.push(["dt",o[n]]);for(n=0;n<c.length;++n)r.push(["dd"].concat(this.processInline(c[n].replace(/(\n)\s+/,"$1"))))}return[r]}},f.dialects.Maruku.inline["{:"]=function(t,e,n){if(!n.length)return[2,"{:"];var i=n[n.length-1];if("string"==typeof i)return[2,"{:"];var r=t.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!r)return[2,"{:"];var a=this.dialect.processMetaHash(r[1]),s=l(i);s||(s={},i.splice(1,0,s));for(var o in a)s[o]=a[o];return[r[0].length,""]},f.buildBlockOrder(f.dialects.Maruku.block),f.buildInlinePatterns(f.dialects.Maruku.inline);var g,v=Array.isArray||function(t){return"[object Array]"==Object.prototype.toString.call(t)};g=Array.prototype.forEach?function(t,e,n){return t.forEach(e,n)}:function(t,e,n){for(var i=0;i<t.length;i++)e.call(n||t,t[i],i,t)},t.renderJsonML=function(t,e){(e=e||{}).root=e.root||!1;var n=[];if(e.root)n.push(c(t));else for(t.shift(),!t.length||"object"!=typeof t[0]||t[0]instanceof Array||t.shift();t.length;)n.push(c(t.shift()));return n.join("\n\n")}}("undefined"==typeof exports?(window.markdown={},window.markdown):exports);var toMarkdown=function(t){function e(t,e){var n="void"===e.type?"<"+e.tag+"\\b([^>]*)\\/?>":"<"+e.tag+"\\b([^>]*)>([\\s\\S]*?)<\\/"+e.tag+">",i=new RegExp(n,"gi");return"string"==typeof e.replacement?t.replace(i,e.replacement):t.replace(i,function(t,n,i,r){return e.replacement.call(this,t,n,i,r)})}function n(t){return new RegExp(t+"\\s*=\\s*[\"']?([^\"']*)[\"']?","i")}function i(t){return"\n\n"+(t=t.replace(/<(ul|ol)\b[^>]*>([\s\S]*?)<\/\1>/gi,function(t,e,n){var i=n.split("</li>");for(i.splice(i.length-1,1),l=0,o=i.length;l<o;l++)if(i[l]){var r="ol"===e?l+1+".  ":"*   ";i[l]=i[l].replace(/\s*<li[^>]*>([\s\S]*)/i,function(t,e){return e=e.replace(/^\s+/,""),e=e.replace(/\n\n/g,"\n\n    "),e=e.replace(/\n([ ]*)+(\*|\d+\.) /g,"\n$1    $2 "),r+e})}return i.join("\n")})).replace(/[ \t]+\n|\s+$/g,"")}function r(t){return t=t.replace(/<blockquote\b[^>]*>([\s\S]*?)<\/blockquote>/gi,function(t,e){return e=e.replace(/^\s+|\s+$/g,""),e=a(e),e=e.replace(/^/gm,"> "),e=e.replace(/^(>([ \t]{2,}>)+)/gm,"> >")})}function a(t){return t=t.replace(/^[\t\r\n]+|[\t\r\n]+$/g,""),t=t.replace(/\n\s+\n/g,"\n\n"),t=t.replace(/\n{3,}/g,"\n\n")}for(var s=[{patterns:"p",replacement:function(t,e,n){return n?"\n\n"+n+"\n":""}},{patterns:"br",type:"void",replacement:"\n"},{patterns:"h([1-6])",replacement:function(t,e,n,i){for(var r="",a=0;a<e;a++)r+="#";return"\n\n"+r+" "+i+"\n"}},{patterns:"hr",type:"void",replacement:"\n\n* * *\n"},{patterns:"a",replacement:function(t,e,i){var r=e.match(n("href")),a=e.match(n("title"));return r?"["+i+"]("+r[1]+(a&&a[1]?' "'+a[1]+'"':"")+")":t}},{patterns:["b","strong"],replacement:function(t,e,n){return n?"**"+n+"**":""}},{patterns:["i","em"],replacement:function(t,e,n){return n?"_"+n+"_":""}},{patterns:"code",replacement:function(t,e,n){return n?"`"+n+"`":""}},{patterns:"img",type:"void",replacement:function(t,e,i){var r=e.match(n("src")),a=e.match(n("alt")),s=e.match(n("title"));return"!["+(a&&a[1]?a[1]:"")+"]("+r[1]+(s&&s[1]?' "'+s[1]+'"':"")+")"}}],l=0,o=s.length;l<o;l++)if("string"==typeof s[l].patterns)t=e(t,{tag:s[l].patterns,replacement:s[l].replacement,type:s[l].type});else for(var c=0,h=s[l].patterns.length;c<h;c++)t=e(t,{tag:s[l].patterns[c],replacement:s[l].replacement,type:s[l].type});t=(t=t.replace(/<pre\b[^>]*>`([\s\S]*)`<\/pre>/gi,function(t,e){return e=e.replace(/^\t+/g,"  "),"\n\n    "+(e=e.replace(/\n/g,"\n    "))+"\n"})).replace(/^(\s{0,3}\d+)\. /g,"$1\\. ");for(var u=/<(ul|ol)\b[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;t.match(u);)t=t.replace(u,function(t){return i(t)});for(var f=/<blockquote\b[^>]*>((?:(?!<blockquote)[\s\S])*?)<\/blockquote>/gi;t.match(f);)t=t.replace(f,function(t){return r(t)});return a(t)};"object"==typeof exports&&(exports.toMarkdown=toMarkdown),function(t){"use strict";var e=function(e,n){var i=["autofocus","savable","hideable","width","height","resize","iconlibrary","language","footer","fullscreen","hiddenButtons","disabledButtons"];t.each(i,function(i,r){void 0!==t(e).data(r)&&((n="object"==typeof n?n:{})[r]=t(e).data(r))}),this.$ns="bootstrap-markdown",this.$element=t(e),this.$editable={el:null,type:null,attrKeys:[],attrValues:[],content:null},this.$options=t.extend(!0,{},t.fn.markdown.defaults,n,this.$element.data("options")),this.$oldContent=null,this.$isPreview=!1,this.$isFullscreen=!1,this.$editor=null,this.$textarea=null,this.$handler=[],this.$callback=[],this.$nextTab=[],this.showEditor()};e.prototype={constructor:e,__alterButtons:function(e,n){var i=this.$handler,r="all"==e,a=this;t.each(i,function(t,i){!1===(!r&&i.indexOf(e)<0)&&n(a.$editor.find('button[data-handler="'+i+'"]'))})},__buildButtons:function(e,n){var i,r=this.$ns,a=this.$handler,s=this.$callback;for(i=0;i<e.length;i++){var l,o=e[i];for(l=0;l<o.length;l++){var c,h=o[l].data,u=t("<div/>",{class:"btn-group"});for(c=0;c<h.length;c++){var f,d,p=h[c],g=r+"-"+p.name,v=this.__getIcon(p.icon),b=p.btnText?p.btnText:"",m=p.btnClass?p.btnClass:"btn",_=p.tabIndex?p.tabIndex:"-1",k=void 0!==p.hotkey?p.hotkey:"",y=void 0!==jQuery.hotkeys&&""!==k?" ("+k+")":"";(f=t("<button></button>")).text(" "+this.__localize(b)).addClass("btn-default btn-sm").addClass(m),m.match(/btn\-(primary|success|info|warning|danger|link)/)&&f.removeClass("btn-default"),f.attr({type:"button",title:this.__localize(p.title)+y,tabindex:_,"data-provider":r,"data-handler":g,"data-hotkey":k}),!0===p.toggle&&f.attr("data-toggle","button"),(d=t("<span/>")).addClass(v),d.prependTo(f),u.append(f),a.push(g),s.push(p.callback)}n.append(u)}}return n},__setListener:function(){var e=void 0!==this.$textarea.attr("rows"),n=this.$textarea.val().split("\n").length>5?this.$textarea.val().split("\n").length:"5",i=e?this.$textarea.attr("rows"):n;this.$textarea.attr("rows",i),this.$options.resize&&this.$textarea.css("resize",this.$options.resize),this.$textarea.on("focus",t.proxy(this.focus,this)).on("keypress",t.proxy(this.keypress,this)).on("keyup",t.proxy(this.keyup,this)).on("change",t.proxy(this.change,this)),this.eventSupported("keydown")&&this.$textarea.on("keydown",t.proxy(this.keydown,this)),this.$textarea.data("markdown",this)},__handle:function(e){var n=t(e.currentTarget),i=this.$handler,r=this.$callback,a=n.attr("data-handler"),s=r[i.indexOf(a)];t(e.currentTarget).focus(),s(this),this.change(this),a.indexOf("cmdSave")<0&&this.$textarea.focus(),e.preventDefault()},__localize:function(e){var n=t.fn.markdown.messages,i=this.$options.language;return void 0!==n&&void 0!==n[i]&&void 0!==n[i][e]?n[i][e]:e},__getIcon:function(t){return"object"==typeof t?t[this.$options.iconlibrary]:t},setFullscreen:function(e){var n=this.$editor,i=this.$textarea;!0===e?(n.addClass("md-fullscreen-mode"),t("body").addClass("md-nooverflow"),this.$options.onFullscreen(this)):(n.removeClass("md-fullscreen-mode"),t("body").removeClass("md-nooverflow")),this.$isFullscreen=e,i.focus()},showEditor:function(){var e,n=this,i=this.$ns,r=this.$element,a=(r.css("height"),r.css("width"),this.$editable),s=this.$handler,l=this.$callback,o=this.$options,c=t("<div/>",{class:"md-editor",click:function(){n.focus()}});if(null===this.$editor){var h=t("<div/>",{class:"md-header btn-toolbar"}),u=[];if(o.buttons.length>0&&(u=u.concat(o.buttons[0])),o.additionalButtons.length>0&&(u=u.concat(o.additionalButtons[0])),o.reorderButtonGroups.length>0&&(u=u.filter(function(t){return o.reorderButtonGroups.indexOf(t.name)>-1}).sort(function(t,e){return o.reorderButtonGroups.indexOf(t.name)<o.reorderButtonGroups.indexOf(e.name)?-1:o.reorderButtonGroups.indexOf(t.name)>o.reorderButtonGroups.indexOf(e.name)?1:0})),u.length>0&&(h=this.__buildButtons([u],h)),o.fullscreen.enable&&h.append('<div class="md-controls"><a class="md-control md-control-fullscreen" href="#"><span class="'+this.__getIcon(o.fullscreen.icons.fullscreenOn)+'"></span></a></div>').on("click",".md-control-fullscreen",function(t){t.preventDefault(),n.setFullscreen(!0)}),c.append(h),r.is("textarea"))r.before(c),(e=r).addClass("md-input"),c.append(e);else{var f="function"==typeof toMarkdown?toMarkdown(r.html()):r.html(),d=t.trim(f);e=t("<textarea/>",{class:"md-input",val:d}),c.append(e),a.el=r,a.type=r.prop("tagName").toLowerCase(),a.content=r.html(),t(r[0].attributes).each(function(){a.attrKeys.push(this.nodeName),a.attrValues.push(this.nodeValue)}),r.replaceWith(c)}var p=t("<div/>",{class:"md-footer"}),g=!1,v="";if(o.savable){g=!0;s.push("cmdSave"),l.push(o.onSave),p.append('<button class="btn btn-success" data-provider="'+i+'" data-handler="cmdSave"><i class="icon icon-white icon-ok"></i> '+this.__localize("Save")+"</button>")}if(v="function"==typeof o.footer?o.footer(this):o.footer,""!==t.trim(v)&&(g=!0,p.append(v)),g&&c.append(p),o.width&&"inherit"!==o.width&&(jQuery.isNumeric(o.width)?(c.css("display","table"),e.css("width",o.width+"px")):c.addClass(o.width)),o.height&&"inherit"!==o.height)if(jQuery.isNumeric(o.height)){var b=o.height;h&&(b=Math.max(0,b-h.outerHeight())),p&&(b=Math.max(0,b-p.outerHeight())),e.css("height",b+"px")}else c.addClass(o.height);this.$editor=c,this.$textarea=e,this.$editable=a,this.$oldContent=this.getContent(),this.__setListener(),this.$editor.attr("id",(new Date).getTime()),this.$editor.on("click",'[data-provider="bootstrap-markdown"]',t.proxy(this.__handle,this)),(this.$element.is(":disabled")||this.$element.is("[readonly]"))&&(this.$editor.addClass("md-editor-disabled"),this.disableButtons("all")),this.eventSupported("keydown")&&"object"==typeof jQuery.hotkeys&&h.find('[data-provider="bootstrap-markdown"]').each(function(){var n=t(this),i=n.attr("data-hotkey");""!==i.toLowerCase()&&e.bind("keydown",i,function(){return n.trigger("click"),!1})}),"preview"===o.initialstate?this.showPreview():"fullscreen"===o.initialstate&&o.fullscreen.enable&&this.setFullscreen(!0)}else this.$editor.show();return o.autofocus&&(this.$textarea.focus(),this.$editor.addClass("active")),o.fullscreen.enable&&!1!==o.fullscreen&&(this.$editor.append('          <div class="md-fullscreen-controls">            <a href="#" class="exit-fullscreen" title="Exit fullscreen"><span class="'+this.__getIcon(o.fullscreen.icons.fullscreenOff)+'"></span></a>          </div>'),this.$editor.on("click",".exit-fullscreen",function(t){t.preventDefault(),n.setFullscreen(!1)})),this.hideButtons(o.hiddenButtons),this.disableButtons(o.disabledButtons),o.onShow(this),this},parseContent:function(t){var t=t||this.$textarea.val();return"object"==typeof markdown?markdown.toHTML(t):"function"==typeof marked?marked(t):t},showPreview:function(){var e,n,i=this.$options,r=this.$textarea,a=r.next(),s=t("<div/>",{class:"md-preview","data-provider":"markdown-preview"});return this.$isPreview=!0,this.disableButtons("all").enableButtons("cmdPreview"),n=i.onPreview(this),e="string"==typeof n?n:this.parseContent(),s.html(e),a&&"md-footer"==a.attr("class")?s.insertBefore(a):r.parent().append(s),s.css({width:r.outerWidth()+"px",height:r.outerHeight()+"px"}),this.$options.resize&&s.css("resize",this.$options.resize),r.hide(),s.data("markdown",this),(this.$element.is(":disabled")||this.$element.is("[readonly]"))&&(this.$editor.addClass("md-editor-disabled"),this.disableButtons("all")),this},hidePreview:function(){return this.$isPreview=!1,this.$editor.find('div[data-provider="markdown-preview"]').remove(),this.enableButtons("all"),this.disableButtons(this.$options.disabledButtons),this.$textarea.show(),this.__setListener(),this},isDirty:function(){return this.$oldContent!=this.getContent()},getContent:function(){return this.$textarea.val()},setContent:function(t){return this.$textarea.val(t),this},findSelection:function(t){var e;if((e=this.getContent().indexOf(t))>=0&&t.length>0){var n,i=this.getSelection();return this.setSelection(e,e+t.length),n=this.getSelection(),this.setSelection(i.start,i.end),n}return null},getSelection:function(){var t=this.$textarea[0];return("selectionStart"in t&&function(){var e=t.selectionEnd-t.selectionStart;return{start:t.selectionStart,end:t.selectionEnd,length:e,text:t.value.substr(t.selectionStart,e)}}||function(){return null})()},setSelection:function(t,e){var n=this.$textarea[0];return("selectionStart"in n&&function(){n.selectionStart=t,n.selectionEnd=e}||function(){return null})()},replaceSelection:function(t){var e=this.$textarea[0];return("selectionStart"in e&&function(){return e.value=e.value.substr(0,e.selectionStart)+t+e.value.substr(e.selectionEnd,e.value.length),e.selectionStart=e.value.length,this}||function(){return e.value+=t,jQuery(e)})()},getNextTab:function(){if(0===this.$nextTab.length)return null;var t,e=this.$nextTab.shift();return"function"==typeof e?t=e():"object"==typeof e&&e.length>0&&(t=e),t},setNextTab:function(t,e){if("string"==typeof t){var n=this;this.$nextTab.push(function(){return n.findSelection(t)})}else if("number"==typeof t&&"number"==typeof e){var i=this.getSelection();this.setSelection(t,e),this.$nextTab.push(this.getSelection()),this.setSelection(i.start,i.end)}},__parseButtonNameParam:function(t){return"string"==typeof t?t.split(","):t},enableButtons:function(e){var n=this.__parseButtonNameParam(e),i=this;return t.each(n,function(t,e){i.__alterButtons(n[t],function(t){t.removeAttr("disabled")})}),this},disableButtons:function(e){var n=this.__parseButtonNameParam(e),i=this;return t.each(n,function(t,e){i.__alterButtons(n[t],function(t){t.attr("disabled","disabled")})}),this},hideButtons:function(e){var n=this.__parseButtonNameParam(e),i=this;return t.each(n,function(t,e){i.__alterButtons(n[t],function(t){t.addClass("hidden")})}),this},showButtons:function(e){var n=this.__parseButtonNameParam(e),i=this;return t.each(n,function(t,e){i.__alterButtons(n[t],function(t){t.removeClass("hidden")})}),this},eventSupported:function(t){var e=t in this.$element;return e||(this.$element.setAttribute(t,"return;"),e="function"==typeof this.$element[t]),e},keyup:function(t){var e=!1;switch(t.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:var n;if(null!==(n=this.getNextTab())){var i=this;setTimeout(function(){i.setSelection(n.start,n.end)},500),e=!0}else{var r=this.getSelection();r.start==r.end&&r.end==this.getContent().length?e=!1:(this.setSelection(this.getContent().length,this.getContent().length),e=!0)}break;case 13:e=!1;break;case 27:this.$isFullscreen&&this.setFullscreen(!1),e=!1;break;default:e=!1}e&&(t.stopPropagation(),t.preventDefault()),this.$options.onChange(this)},change:function(t){return this.$options.onChange(this),this},focus:function(e){var n=this.$options,i=(n.hideable,this.$editor);return i.addClass("active"),t(document).find(".md-editor").each(function(){if(t(this).attr("id")!==i.attr("id")){var e;null===(e=t(this).find("textarea").data("markdown"))&&(e=t(this).find('div[data-provider="markdown-preview"]').data("markdown")),e&&e.blur()}}),n.onFocus(this),this},blur:function(e){var n=this.$options,i=n.hideable,r=this.$editor,a=this.$editable;if(r.hasClass("active")||0===this.$element.parent().length){if(r.removeClass("active"),i)if(null!==a.el){var s=t("<"+a.type+"/>"),l=this.getContent(),o="object"==typeof markdown?markdown.toHTML(l):l;t(a.attrKeys).each(function(t,e){s.attr(a.attrKeys[t],a.attrValues[t])}),s.html(o),r.replaceWith(s)}else r.hide();n.onBlur(this)}return this}};var n=t.fn.markdown;t.fn.markdown=function(n){return this.each(function(){var i=t(this),r=i.data("markdown"),a="object"==typeof n&&n;r||i.data("markdown",r=new e(this,a))})},t.fn.markdown.messages={},t.fn.markdown.defaults={autofocus:!1,hideable:!1,savable:!1,width:"inherit",height:"inherit",resize:"none",iconlibrary:"glyph",language:"en",initialstate:"editor",buttons:[[{name:"groupFont",data:[{name:"cmdBold",hotkey:"Ctrl+B",title:"Bold",icon:{glyph:"glyphicon glyphicon-bold",fa:"fa fa-bold","fa-3":"icon-bold"},callback:function(t){var e,n,i=t.getSelection(),r=t.getContent();e=0===i.length?t.__localize("strong text"):i.text,"**"===r.substr(i.start-2,2)&&"**"===r.substr(i.end,2)?(t.setSelection(i.start-2,i.end+2),t.replaceSelection(e),n=i.start-2):(t.replaceSelection("**"+e+"**"),n=i.start+2),t.setSelection(n,n+e.length)}},{name:"cmdItalic",title:"Italic",hotkey:"Ctrl+I",icon:{glyph:"glyphicon glyphicon-italic",fa:"fa fa-italic","fa-3":"icon-italic"},callback:function(t){var e,n,i=t.getSelection(),r=t.getContent();e=0===i.length?t.__localize("emphasized text"):i.text,"_"===r.substr(i.start-1,1)&&"_"===r.substr(i.end,1)?(t.setSelection(i.start-1,i.end+1),t.replaceSelection(e),n=i.start-1):(t.replaceSelection("_"+e+"_"),n=i.start+1),t.setSelection(n,n+e.length)}},{name:"cmdHeading",title:"Heading",hotkey:"Ctrl+H",icon:{glyph:"glyphicon glyphicon-header",fa:"fa fa-header","fa-3":"icon-font"},callback:function(t){var e,n,i,r,a=t.getSelection(),s=t.getContent();e=0===a.length?t.__localize("heading text"):a.text+"\n",i=4,"### "===s.substr(a.start-i,i)||(i=3,"###"===s.substr(a.start-i,i))?(t.setSelection(a.start-i,a.end),t.replaceSelection(e),n=a.start-i):a.start>0&&(r=s.substr(a.start-1,1))&&"\n"!=r?(t.replaceSelection("\n\n### "+e),n=a.start+6):(t.replaceSelection("### "+e),n=a.start+4),t.setSelection(n,n+e.length)}}]},{name:"groupLink",data:[{name:"cmdUrl",title:"URL/Link",hotkey:"Ctrl+L",icon:{glyph:"glyphicon glyphicon-link",fa:"fa fa-link","fa-3":"icon-link"},callback:function(e){var n,i,r,a=e.getSelection();e.getContent();if(n=0===a.length?e.__localize("enter link description here"):a.text,null!==(r=prompt(e.__localize("Insert Hyperlink"),"http://"))&&""!==r&&"http://"!==r&&"http"===r.substr(0,4)){var s=t("<div>"+r+"</div>").text();e.replaceSelection("["+n+"]("+s+")"),i=a.start+1,e.setSelection(i,i+n.length)}}},{name:"cmdImage",title:"Image",hotkey:"Ctrl+G",icon:{glyph:"glyphicon glyphicon-picture",fa:"fa fa-picture-o","fa-3":"icon-picture"},callback:function(e){var n,i,r,a=e.getSelection();e.getContent();if(n=0===a.length?e.__localize("enter image description here"):a.text,null!==(r=prompt(e.__localize("Insert Image Hyperlink"),"http://"))&&""!==r&&"http://"!==r&&"http"===r.substr(0,4)){var s=t("<div>"+r+"</div>").text();e.replaceSelection("!["+n+"]("+s+' "'+e.__localize("enter image title here")+'")'),i=a.start+2,e.setNextTab(e.__localize("enter image title here")),e.setSelection(i,i+n.length)}}}]},{name:"groupMisc",data:[{name:"cmdList",hotkey:"Ctrl+U",title:"Unordered List",icon:{glyph:"glyphicon glyphicon-list",fa:"fa fa-list","fa-3":"icon-list-ul"},callback:function(e){var n,i,r=e.getSelection();e.getContent();if(0===r.length)n=e.__localize("list text here"),e.replaceSelection("- "+n),i=r.start+2;else if(r.text.indexOf("\n")<0)n=r.text,e.replaceSelection("- "+n),i=r.start+2;else{var a=[];n=(a=r.text.split("\n"))[0],t.each(a,function(t,e){a[t]="- "+e}),e.replaceSelection("\n\n"+a.join("\n")),i=r.start+4}e.setSelection(i,i+n.length)}},{name:"cmdListO",hotkey:"Ctrl+O",title:"Ordered List",icon:{glyph:"glyphicon glyphicon-th-list",fa:"fa fa-list-ol","fa-3":"icon-list-ol"},callback:function(e){var n,i,r=e.getSelection();e.getContent();if(0===r.length)n=e.__localize("list text here"),e.replaceSelection("1. "+n),i=r.start+3;else if(r.text.indexOf("\n")<0)n=r.text,e.replaceSelection("1. "+n),i=r.start+3;else{var a=[];n=(a=r.text.split("\n"))[0],t.each(a,function(t,e){a[t]="1. "+e}),e.replaceSelection("\n\n"+a.join("\n")),i=r.start+5}e.setSelection(i,i+n.length)}},{name:"cmdCode",hotkey:"Ctrl+K",title:"Code",icon:{glyph:"glyphicon glyphicon-asterisk",fa:"fa fa-code","fa-3":"icon-code"},callback:function(t){var e,n,i=t.getSelection(),r=t.getContent();e=0===i.length?t.__localize("code text here"):i.text,"```\n"===r.substr(i.start-4,4)&&"\n```"===r.substr(i.end,4)?(t.setSelection(i.start-4,i.end+4),t.replaceSelection(e),n=i.start-4):"`"===r.substr(i.start-1,1)&&"`"===r.substr(i.end,1)?(t.setSelection(i.start-1,i.end+1),t.replaceSelection(e),n=i.start-1):r.indexOf("\n")>-1?(t.replaceSelection("```\n"+e+"\n```"),n=i.start+4):(t.replaceSelection("`"+e+"`"),n=i.start+1),t.setSelection(n,n+e.length)}},{name:"cmdQuote",hotkey:"Ctrl+Q",title:"Quote",icon:{glyph:"glyphicon glyphicon-comment",fa:"fa fa-quote-left","fa-3":"icon-quote-left"},callback:function(e){var n,i,r=e.getSelection();e.getContent();if(0===r.length)n=e.__localize("quote here"),e.replaceSelection("> "+n),i=r.start+2;else if(r.text.indexOf("\n")<0)n=r.text,e.replaceSelection("> "+n),i=r.start+2;else{var a=[];n=(a=r.text.split("\n"))[0],t.each(a,function(t,e){a[t]="> "+e}),e.replaceSelection("\n\n"+a.join("\n")),i=r.start+4}e.setSelection(i,i+n.length)}}]},{name:"groupUtil",data:[{name:"cmdPreview",toggle:!0,hotkey:"Ctrl+P",title:"Preview",btnText:"Preview",btnClass:"btn btn-primary btn-sm",icon:{glyph:"glyphicon glyphicon-search",fa:"fa fa-search","fa-3":"icon-search"},callback:function(t){!1===t.$isPreview?t.showPreview():t.hidePreview()}}]}]],additionalButtons:[],reorderButtonGroups:[],hiddenButtons:[],disabledButtons:[],footer:"",fullscreen:{enable:!0,icons:{fullscreenOn:{fa:"fa fa-expand",glyph:"glyphicon glyphicon-fullscreen","fa-3":"icon-resize-full"},fullscreenOff:{fa:"fa fa-compress",glyph:"glyphicon glyphicon-fullscreen","fa-3":"icon-resize-small"}}},onShow:function(t){},onPreview:function(t){},onSave:function(t){},onBlur:function(t){},onFocus:function(t){},onChange:function(t){},onFullscreen:function(t){}},t.fn.markdown.Constructor=e,t.fn.markdown.noConflict=function(){return t.fn.markdown=n,this};var i=function(t){var e=t;e.data("markdown")?e.data("markdown").showEditor():e.markdown()},r=function(e){var n=t(document.activeElement);t(document).find(".md-editor").each(function(){var e=t(this),i=n.closest(".md-editor")[0]===this,r=e.find("textarea").data("markdown")||e.find('div[data-provider="markdown-preview"]').data("markdown");r&&!i&&r.blur()})};t(document).on("click.markdown.data-api",'[data-provide="markdown-editable"]',function(e){i(t(this)),e.preventDefault()}).on("click focusin",function(t){r()}).ready(function(){t('textarea[data-provide="markdown"]').each(function(){i(t(this))})})}(window.jQuery);